#!/usr/bin/env ruby

$LOAD_PATH.unshift("lib")

require 'dllt'


EM.kqueue = true if EM.kqueue? # file watching requires kqueue on OSX

EventMachine::run do
  FILE_PATH = 'dictionary/dictionary.txt'

  def DLLT.get_words
    words  = []

    File.read(FILE_PATH).lines{|substr| words <<  substr.chomp  }
    a,b = words[rand(words.count)].split(':')

    if a && b
      [a.split, b.split]
    else
      ['Linea', 'maliciosa']
    end
  end

  DLLT::ClientServer.start('192.168.1.111:9001', '9002')
  DLLT::Guard.start(FILE_PATH)
  DLLT::Unison.start('9000')
  DLLT::WebClient.run!({:port => 3000})

  quit = Proc.new {
    puts "quitting EM"
    DLLT::ClientServer.unregister
    EM.stop
  }

  Signal.trap "INT", quit
  Signal.trap "TERM", quit
end
